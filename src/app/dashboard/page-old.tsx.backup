'use client'

import { useState, useEffect } from 'react'
import { useSession } from 'next-auth/react'
import { useRouter } from 'next/navigation'
import StudyPlan from '@/components/StudyPlan'
import StreakDisplay from '@/components/StreakDisplay'
import FocusTimer from '@/components/FocusTimer'

export default function DashboardPage() {
  const { data: session, status } = useSession()
  const router = useRouter()
  const [loading, setLoading] = useState(true)
  const [studyPlan, setStudyPlan] = useState<any>(null)
  const [streak, setStreak] = useState<any>(null)
  const [showTimer, setShowTimer] = useState(false)

  useEffect(() => {
    if (status === 'unauthenticated') {
      router.push('/auth/signin')
    } else if (status === 'authenticated') {
      fetchDashboardData()
    }
  }, [status, router])

  const fetchDashboardData = async () => {
    try {
      const [planRes, streakRes] = await Promise.all([
        fetch('/api/study-plan'),
        fetch('/api/streak'),
      ])

      if (planRes.status === 403) {
        // Needs premium
        router.push('/pricing')
        return
      }

      if (planRes.ok) {
        const planData = await planRes.json()
        setStudyPlan(planData.plan)
      }

      if (streakRes.ok) {
        const streakData = await streakRes.json()
        setStreak(streakData.streak)
      }
    } catch (error) {
      console.error('Dashboard error:', error)
    } finally {
      setLoading(false)
    }
  }

  const handleTaskComplete = async (taskIndex: number) => {
    try {
      const response = await fetch('/api/study-plan', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          planId: studyPlan.id,
          taskIndex,
          completed: true,
        }),
      })

      if (response.ok) {
        const data = await response.json()
        setStudyPlan(data.plan)
        // Refresh streak
        const streakRes = await fetch('/api/streak')
        if (streakRes.ok) {
          const streakData = await streakRes.json()
          setStreak(streakData.streak)
        }
      }
    } catch (error) {
      console.error('Task complete error:', error)
    }
  }

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-xl text-gray-600">Loading...</div>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <nav className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
          <div className="flex justify-between items-center">
            <h1 className="text-2xl font-bold text-blue-600">StudyFocus</h1>
            <div className="flex gap-2 md:gap-4 flex-wrap">
              <button
                onClick={() => router.push('/analytics')}
                className="px-3 md:px-4 py-2 text-sm md:text-base bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition"
              >
                ğŸ“Š Analytics
              </button>
              <button
                onClick={() => router.push('/notes')}
                className="px-3 md:px-4 py-2 text-sm md:text-base bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
              >
                ğŸ“ Notes
              </button>
              <button
                onClick={() => router.push('/calendar')}
                className="px-3 md:px-4 py-2 text-sm md:text-base bg-pink-600 text-white rounded-lg hover:bg-pink-700 transition"
              >
                ğŸ“… Calendar
              </button>
              <button
                onClick={() => router.push('/achievements')}
                className="px-3 md:px-4 py-2 text-sm md:text-base bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition"
              >
                ğŸ† Achievements
              </button>
              <button
                onClick={() => setShowTimer(!showTimer)}
                className="px-3 md:px-4 py-2 text-sm md:text-base bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
              >
                {showTimer ? 'Hide Timer' : 'â±ï¸ Focus'}
              </button>
              <button
                onClick={() => router.push('/doubts')}
                className="px-3 md:px-4 py-2 text-sm md:text-base bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition"
              >
                ğŸ’¡ Ask Doubt
              </button>
              <button
                onClick={() => router.push('/settings')}
                className="px-3 md:px-4 py-2 text-sm md:text-base bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition"
              >
                âš™ï¸ Settings
              </button>
            </div>
          </div>
        </div>
      </nav>

      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {session?.user?.subscriptionStatus === 'free' && (
          <div className="mb-6 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl p-4 shadow-lg">
            <div className="flex items-center justify-between">
              <div>
                <h3 className="font-bold text-lg">ğŸ†“ Free Plan</h3>
                <p className="text-sm opacity-90">3 subjects â€¢ 3 tasks/day â€¢ 3 doubts/day</p>
              </div>
              <button
                onClick={() => router.push('/pricing')}
                className="px-4 py-2 bg-white text-blue-600 rounded-lg font-semibold hover:bg-gray-100 transition"
              >
                Upgrade to Premium
              </button>
            </div>
          </div>
        )}
        
        <div className="grid md:grid-cols-3 gap-6 mb-8">
          <div className="md:col-span-2">
            {studyPlan ? (
              <StudyPlan
                tasks={studyPlan.tasks}
                planId={studyPlan.id}
                onTaskComplete={handleTaskComplete}
              />
            ) : (
              <div className="bg-white rounded-xl shadow-lg p-6">
                <p className="text-gray-600">
                  No study plan for today. Check back tomorrow!
                </p>
              </div>
            )}
          </div>
          <div>
            {streak && (
              <StreakDisplay
                currentStreak={streak.currentStreak}
                longestStreak={streak.longestStreak}
                totalDays={streak.totalDays}
              />
            )}
          </div>
        </div>

        {showTimer && (
          <div className="flex justify-center">
            <FocusTimer
              onComplete={async () => {
                // Log focus session
                await fetch('/api/focus', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    subject: 'General',
                    duration: 25,
                    type: 'pomodoro',
                  }),
                })
                setShowTimer(false)
              }}
            />
          </div>
        )}
      </main>
    </div>
  )
}
